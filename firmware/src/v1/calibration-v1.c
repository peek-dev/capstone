/**
 * Copyright (C) 2024 John E. Berberian, Jr.
 *
 * calibration-v1.c: provides per-square calibration bins to the sensor driver.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>
 */
#include "calibration.h"
#if HARDWARE_REVISION == 1

#include "assert.h"
#define NBINS 13

// Lower bounds for hall effect sensor reading bins.
const uint16_t bins[8][8][NBINS] =
{{{   0,  638, 1222, 1468, 1688, 1834, 1975, 2118, 2252, 2418, 2624, 2904, 3574},
  {   0,  703, 1293, 1516, 1706, 1843, 1976, 2115, 2246, 2404, 2595, 2858, 3549},
  {   0,  714, 1287, 1510, 1706, 1847, 1976, 2116, 2247, 2404, 2590, 2864, 3577},
  {   0,  604, 1188, 1475, 1695, 1818, 1964, 2109, 2249, 2420, 2635, 2933, 3605},
  {   0,  939, 1370, 1561, 1719, 1841, 1969, 2097, 2217, 2358, 2523, 2745, 3320},
  {   0,  855, 1391, 1601, 1745, 1870, 2003, 2134, 2256, 2403, 2575, 2819, 3477},
  {   0,  543, 1164, 1459, 1656, 1824, 1984, 2139, 2287, 2477, 2705, 3032, 3685},
  {   0,  527, 1073, 1417, 1627, 1808, 1974, 2136, 2295, 2493, 2745, 3107, 3718},},

 {{   0,  492, 1106, 1367, 1609, 1796, 1965, 2128, 2289, 2496, 2756, 3116, 3733},
  {   0,  454, 1079, 1363, 1594, 1786, 1959, 2127, 2290, 2503, 2774, 3155, 3758},
  {   0,  511, 1139, 1473, 1631, 1815, 1985, 2151, 2310, 2520, 2769, 3149, 3733},
  {   0,  559, 1169, 1489, 1656, 1820, 1978, 2126, 2282, 2477, 2724, 3040, 3681},
  {   0,  507, 1076, 1391, 1620, 1802, 1969, 2132, 2291, 2495, 2747, 3102, 3731},
  {   0,  522, 1181, 1478, 1641, 1815, 1977, 2133, 2288, 2487, 2736, 3084, 3643},
  {   0,  519, 1089, 1392, 1615, 1791, 1953, 2115, 2267, 2467, 2713, 3056, 3695},
  {   0,  620, 1243, 1496, 1663, 1815, 1961, 2107, 2248, 2423, 2629, 2869, 3608},},

 {{   0,  525, 1124, 1425, 1634, 1813, 1976, 2133, 2285, 2481, 2723, 3059, 3709},
  {   0,  494, 1108, 1406, 1615, 1794, 1962, 2126, 2286, 2492, 2751, 3115, 3731},
  {   0,  512, 1119, 1415, 1642, 1841, 1987, 2151, 2309, 2513, 2761, 3115, 3741},
  {   0,  508, 1122, 1384, 1609, 1789, 1949, 2108, 2262, 2458, 2707, 3030, 3690},
  {   0,  500, 1099, 1396, 1627, 1803, 1966, 2127, 2282, 2481, 2730, 3073, 3732},
  {   0,  493, 1102, 1392, 1618, 1797, 1958, 2118, 2273, 2470, 2711, 3056, 3725},
  {   0,  576, 1203, 1467, 1661, 1831, 1972, 2123, 2267, 2448, 2666, 2978, 3654},
  {   0,  580, 1225, 1466, 1666, 1838, 1984, 2139, 2284, 2469, 2693, 3018, 3672},},

 {{   0,  599, 1194, 1460, 1674, 1859, 1996, 2151, 2296, 2482, 2715, 3037, 3660},
  {   0,  580, 1146, 1414, 1644, 1818, 1978, 2137, 2288, 2484, 2737, 3081, 3697},
  {   0,  904, 1407, 1593, 1751, 1882, 2009, 2136, 2257, 2399, 2563, 2791, 3411},
  {   0, 1024, 1441, 1617, 1764, 1885, 2002, 2123, 2236, 2372, 2515, 2731, 3283},
  {   0, 1034, 1462, 1632, 1775, 1895, 2011, 2131, 2242, 2376, 2522, 2726, 3251},
  {   0, 1038, 1470, 1640, 1781, 1895, 2010, 2129, 2237, 2367, 2513, 2709, 3219},
  {   0, 1060, 1469, 1646, 1792, 1904, 2021, 2138, 2250, 2379, 2530, 2730, 3272},
  {   0,  632, 1275, 1531, 1693, 1840, 1979, 2122, 2259, 2426, 2627, 2905, 3611},},

 {{   0,  469, 1106, 1424, 1635, 1821, 1981, 2141, 2298, 2491, 2748, 3071, 3779},
  {   0,  568, 1224, 1487, 1672, 1833, 1981, 2133, 2282, 2459, 2680, 2977, 3699},
  {   0,  582, 1252, 1481, 1672, 1833, 1981, 2133, 2279, 2447, 2673, 2947, 3671},
  {   0,  429, 1069, 1400, 1625, 1806, 1982, 2147, 2308, 2510, 2773, 3105, 3837},
  {   0,  432, 1096, 1396, 1626, 1806, 1978, 2145, 2305, 2511, 2765, 3097, 3827},
  {   0,  555, 1203, 1454, 1656, 1815, 1970, 2122, 2267, 2447, 2672, 2956, 3689},
  {   0,  667, 1267, 1508, 1706, 1848, 1995, 2140, 2277, 2449, 2650, 2919, 3640},
  {   0,  684, 1265, 1509, 1690, 1840, 1988, 2132, 2271, 2441, 2638, 2900, 3650},},

 {{   0,  952, 1393, 1593, 1738, 1865, 1986, 2112, 2231, 2367, 2545, 2747, 3314},
  {   0, 1038, 1426, 1630, 1745, 1870, 1995, 2121, 2240, 2374, 2545, 2741, 3265},
  {   0,  560, 1163, 1467, 1678, 1836, 1992, 2145, 2296, 2477, 2720, 3019, 3731},
  {   0,  510, 1115, 1423, 1638, 1812, 1973, 2132, 2286, 2476, 2729, 3057, 3730},
  {   0,  554, 1226, 1469, 1668, 1826, 1980, 2131, 2276, 2453, 2676, 2971, 3683},
  {   0,  534, 1193, 1447, 1646, 1806, 1960, 2112, 2257, 2439, 2661, 2965, 3681},
  {   0,  480, 1107, 1425, 1642, 1811, 1974, 2133, 2286, 2483, 2718, 3048, 3755},
  {   0,  561, 1217, 1464, 1668, 1825, 1982, 2135, 2280, 2463, 2685, 2986, 3684},},

 {{   0,  677, 1257, 1483, 1672, 1828, 1972, 2117, 2255, 2418, 2645, 2907, 3622},
  {   0,  509, 1133, 1423, 1638, 1821, 1977, 2135, 2289, 2479, 2733, 3059, 3741},
  {   0,  534, 1162, 1452, 1655, 1823, 1979, 2132, 2280, 2459, 2701, 3007, 3706},
  {   0,  546, 1166, 1463, 1660, 1829, 1984, 2135, 2283, 2460, 2699, 2991, 3717},
  {   0,  483, 1090, 1416, 1635, 1811, 1976, 2136, 2293, 2484, 2739, 3067, 3767},
  {   0,  529, 1143, 1445, 1656, 1808, 1967, 2121, 2269, 2450, 2678, 2984, 3695},
  {   0,  489, 1082, 1400, 1622, 1796, 1964, 2126, 2280, 2477, 2724, 3059, 3743},
  {   0,  480, 1087, 1396, 1616, 1789, 1954, 2113, 2265, 2463, 2706, 3044, 3740},},

 {{   0,  548, 1196, 1471, 1664, 1828, 1981, 2133, 2277, 2456, 2686, 2975, 3694},
  {   0,  615, 1185, 1467, 1663, 1826, 1980, 2131, 2276, 2457, 2683, 2984, 3682},
  {   0,  563, 1216, 1477, 1670, 1828, 1977, 2121, 2261, 2434, 2665, 2947, 3669},
  {   0,  478, 1073, 1399, 1624, 1800, 1966, 2128, 2285, 2487, 2740, 3081, 3765},
  {   0,  884, 1331, 1559, 1725, 1847, 1982, 2109, 2229, 2375, 2561, 2786, 3377},
  {   0,  473, 1097, 1434, 1618, 1793, 1959, 2123, 2277, 2478, 2719, 3073, 3752},
  {   0,  451, 1044, 1371, 1602, 1779, 1952, 2116, 2273, 2476, 2728, 3087, 3773},
  {   0,  521, 1116, 1416, 1630, 1794, 1958, 2115, 2267, 2459, 2688, 3002, 3702}}};

PieceType xValueToPiece(uint16_t value, uint8_t row, uint8_t col) {
    assert(row < 8 && col < 8);
    uint8_t i;
    for (i = 1; i < NBINS; i++) {
        if (bins[row][col][i] > value) {
            break;
        }
    }

    return (PieceType)(i - 1);
}

#endif